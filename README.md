# 運行記録 PWA

大型ダンプの運転手向けに設計された運行記録アプリです。出発地・目的地、出発時刻・到着時刻、走行距離、休憩時間、給油量などを記録し、Google スプレッドシートへ自動的に同期します。オフラインでも動作する PWA（Progressive Web App）として実装されており、端末のホーム画面に追加してネイティブアプリのように利用できます。AI（OpenAI）と連携することで自然文からの自動入力やログの要約生成も可能です。  

## 特長

- **走行セッション管理** – 走行開始／終了、休憩開始／終了、給油記録をワンタップで操作できます。GPS により走行距離を自動計算します。  
- **オフライン対応** – オフライン時でもログを作成でき、再接続時に自動でスプレッドシートへ同期します。  
- **Google スプレッドシート連携** – Apps Script を利用してスプレッドシートへ JSON 送信し、シートに追記します。設定が簡単で OAuth 認証も不要です。  
- **AI 支援（任意）** – 自然言語から運行記録を抽出したり、記録の要約を生成したりできます（OpenAI API キーが必要）。  
- **PWA** – ホーム画面追加、オフラインキャッシュ、レスポンシブ対応。折りたたみ端末や大画面でも使いやすい二画面レイアウトに対応しています。  

## ディレクトリ構成

```
/ (repo root)
  ├─ public/            # アイコンなどの静的ファイル
  ├─ src/
  │   ├─ index.html     # アプリのHTML
  │   ├─ main.ts        # エントリーポイント
  │   ├─ sw.ts          # サービスワーカー
  │   ├─ db.ts          # IndexedDB 操作用
  │   ├─ geo.ts         # GPS＆距離計算
  │   ├─ ai.ts          # AI 連携
  │   ├─ styles.css     # 追加CSS
  │   └─ ui/            # UIコンポーネント（今回は未使用）
  ├─ manifest.json      # PWA マニフェスト
  ├─ package.json       # npm スクリプト
  ├─ vite.config.ts     # Vite 設定
  ├─ config.example.json# 設定ファイルの雛形
  ├─ Code.gs            # Google Apps Script
  ├─ .github/workflows/deploy.yml # GitHub Pages 用ワークフロー
  └─ README.md
```

## セットアップ手順

以下の手順でローカル開発環境を構築し、Google スプレッドシートとの連携を設定します。

### 1. リポジトリのクローンと依存関係インストール

```
git clone <このリポジトリ URL>
cd transport-pwa
npm install
```

### 2. 設定ファイルの作成

`config.example.json` をコピーして `config.json` を作成し、以下の項目を設定します。

- `SHEETS_WEBAPP_URL` – Google Apps Script をデプロイした Web アプリの URL。
- `OPENAI_API_KEY` – （AI 機能を使用する場合のみ）OpenAI の API キー。

```json
{
  "SHEETS_WEBAPP_URL": "https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/exec",
  "OPENAI_API_KEY": "sk-..."
}
```

Git には `config.json` をコミットしないよう `.gitignore` に含めてください（当リポジトリでは `.gitignore` は省略しています）。

### 3. Google スプレッドシートおよび Apps Script の設定

1. **スプレッドシートの作成** – 新しい Google スプレッドシートを作成します。  
2. **Apps Script の追加** – スプレッドシート上で「拡張機能 ＞ Apps Script」を選び、このリポジトリの `Code.gs` の内容を貼り付けます。  
3. **ヘッダ行の生成** – スクリプトエディタで `onOpen()` を一度実行するとヘッダ行が追加されます（手動でもヘッダを入力できます）。  
4. **Web アプリとして公開** – `デプロイ ＞ 新しいデプロイ` を選択し、タイプを「ウェブアプリ」に指定してデプロイします。アクセス権は「全員」に設定し、デプロイ後に生成される URL をコピーします（これを `SHEETS_WEBAPP_URL` に設定します）。  
5. **CORS 設定** – 特別な設定は不要ですが、デプロイ画面で「ウェブアプリとして公開」されているか確認してください。  

### 4. アプリの起動

ローカル開発サーバで確認するには：

```
npm run dev
```

ブラウザで `http://localhost:5173` を開くとアプリが表示されます。初回アクセス時に位置情報アクセス許可を求められますので「許可」を選択してください。

### 5. ビルドと GitHub Pages への公開

GitHub Actions ワークフローが用意されているため、`main` ブランチにプッシュすると自動でビルドと `gh-pages` ブランチへのデプロイが行われます。自分で手動ビルドしたい場合は次のコマンドを実行します：

```
npm run build
```

生成された `dist/` ディレクトリを任意の静的ホスティング環境に配置することでアプリを公開できます。GitHub Pages を利用する場合は `gh-pages` ブランチに `dist/` の内容を push してください。

## 使い方

### 走行セッションの記録

1. **走行開始** – アプリのダッシュボードで「走行開始」ボタンをタップすると新しいセッションが始まります。現在地が取得され、GPS 追跡が開始されます。  
2. **休憩** – 「休憩開始」をタップすると休憩が記録されます。休憩中にもう一度タップすると休憩終了として計測されます。休憩時間は走行時間から差し引かれます。  
3. **給油** – 「給油記録」をタップすると給油量（必須）と費用（任意）を入力できます。入力した数値は後で合計されます。  
4. **走行終了** – 「走行終了」をタップするとセッションが終了し、記録のまとめが表示されます。出発地名・到着地名・備考を入力して保存します。保存後、データは IndexedDB に保存され、オンライン時には即座にスプレッドシートへ送信されます。

### AI アシスタント機能（任意）

`config.json` に `OPENAI_API_KEY` を設定すると、ダッシュボードに「AIアシスタント」セクションが表示されます。

- **自然文から運行記録を作成** – 自然言語（例：「今日は6時に札幌を出発し、12時に帯広に到着しました。途中30分休憩し、250km走行しました。100L給油しました。」）を入力すると、GPT が主要項目を抽出してログを生成します。  
- **ログの要約を作成** – 保存されている全ログを GPT が分析し、合計走行距離や運転時間などを日本語でまとめたレポートを生成します。

## UI 画面遷移図（簡略）

```
 ダッシュボード
   ├─ 走行開始 → 走行中画面
   │                ├─ 休憩開始/終了
   │                ├─ 給油記録
   │                └─ 走行終了 → 入力ダイアログ → ダッシュボード
   ├─ 過去の走行ログ一覧
   └─ AIアシスタント（APIキー設定時）
```

### アクセシビリティ指針

- タップ領域は最低 44px 四方を確保し、大型ボタンで運転中でも操作しやすくしています。  
- 色覚異常に配慮した配色と十分なコントラストを採用しています。  
- キーボードフォーカス時のアウトラインや aria-label を適切に設定しています。  
- 音声入力と出力（Web Speech API）を用いてハンズフリー操作が可能です（ブラウザ対応状況に依存します）。

## テスト手順

1. **ローカルでの疑似移動テスト** – ブラウザの開発者ツールから「Sensors」→「Geolocation」を設定し、違う座標を順に設定することで走行距離計算が正しく行われるか確認できます。  
2. **オフラインでの記録→同期テスト** – ブラウザのネットワークをオフラインモードにしてログを作成し、モードを戻した際にスプレッドシートに自動反映されることを確認します。  
3. **スプレッドシート反映確認** – Apps Script の Web アプリ URL が正しく設定されていることを確認し、走行終了後にシートへ新しい行が追加されることをチェックします。

## 法的・安全上の注意

- 運転中の端末操作は危険を伴います。本アプリの操作は必ず安全な場所に停車してから行ってください。  
- 音声入力を使用する場合も交通状況に注意し、両手での運転を心掛けてください。  
- 位置情報や音声データはログ作成のみに使用され、他用途に利用しないでください。また、同乗者や周囲の人物のプライバシーに配慮し、必要以上の録音・撮影は避けてください。

## 将来拡張案

- **ジオフェンスによる自動到着判定** – 目的地周辺に到達したことを自動検知して走行終了を提案する機能。  
- **勤務規程別レポート** – 労働時間規制に基づき、週・月単位で運転時間・休憩時間を集計し、規程超過をアラートする機能。  
- **マルチユーザー対応** – 複数ドライバーのログを分けて管理し、会社全体での車両運行管理ができる管理者画面の追加。  
- **クラスタリングされた休憩地点の提案** – 過去ログを分析して、最適な休憩場所や給油所を提案する機能。

---

本アプリは MIT ライセンスのもとオープンソースとして公開されています。Issue や Pull Request によるフィードバックを歓迎します。