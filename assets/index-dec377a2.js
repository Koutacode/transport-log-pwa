(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=e(o);fetch(o.href,r)}})();const _="transport-log-db",R=1,v="logs",y="pending";function E(){return new Promise((t,n)=>{const e=indexedDB.open(_,R);e.onupgradeneeded=a=>{const o=e.result;o.objectStoreNames.contains(v)||o.createObjectStore(v,{keyPath:"id",autoIncrement:!0}),o.objectStoreNames.contains(y)||o.createObjectStore(y,{keyPath:"id",autoIncrement:!0})},e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})}async function j(t,n=!1){const e=await E();return new Promise((a,o)=>{const r=e.transaction([v,y],"readwrite");r.objectStore(v).add(t),n&&r.objectStore(y).add(t),r.oncomplete=()=>a(),r.onerror=()=>o(r.error)})}async function M(){const t=await E();return new Promise((n,e)=>{const r=t.transaction(v,"readonly").objectStore(v).getAll();r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function k(){const t=await E();return new Promise((n,e)=>{const r=t.transaction(y,"readonly").objectStore(y).getAll();r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function H(){const t=await E();return new Promise((n,e)=>{const a=t.transaction(y,"readwrite");a.objectStore(y).clear(),a.oncomplete=()=>n(),a.onerror=()=>e(a.error)})}async function K(t){const n=await E();return new Promise((e,a)=>{const o=n.transaction([v,y],"readwrite");o.objectStore(v).delete(t),o.objectStore(y).delete(t),o.oncomplete=()=>e(),o.onerror=()=>a(o.error)})}const U=6371;function $(t){return t*Math.PI/180}function q(t,n){const e=$(n.lat-t.lat),a=$(n.lng-t.lng),o=$(t.lat),r=$(n.lat),l=Math.sin(e/2)**2+Math.sin(a/2)**2*Math.cos(o)*Math.cos(r),u=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return U*u}function J(t,n){if(!("geolocation"in navigator))throw new Error("Geolocation is not supported by this browser");return navigator.geolocation.watchPosition(a=>{const{latitude:o,longitude:r}=a.coords;t({lat:o,lng:r,timestamp:a.timestamp})},a=>{n&&n(a)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:6e4})}function W(t){"geolocation"in navigator&&navigator.geolocation.clearWatch(t)}async function F(){try{const t=await fetch("/config.json");if(!t.ok)throw new Error("Config not found");return await t.json()}catch{return{}}}async function z(t){const e=(await F()).OPENAI_API_KEY;if(!e)throw new Error("OpenAI API key is not configured");const o={model:"gpt-3.5-turbo",messages:[{role:"system",content:'あなたは大型トラック運込手の運行記録を構造化データに変換するアシスタントです。入力は日本語の文章で、出発地/到着地、出発時刻/到着時刻、休憩時間、走行距離、給油量と費用などが含まれます。次のJSON形式で応答してください: {"departureName":"文字列","arrivalName":"文字列","departureTime":"ISO日時","arrivalTime":"ISO日時","drivingMinutes":数値,"breakMinutes":数値,"distanceKm":数値,"fuelLitres":数値,"fuelCost":数値,"note":"文字列"}。入力に含まれない項目はnullまたは0にしてください。'},{role:"user",content:t}],temperature:0},u=(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)})).json()).choices[0].message.content;try{return JSON.parse(u)}catch{throw new Error("Failed to parse OpenAI response")}}async function G(t){const e=(await F()).OPENAI_API_KEY;if(!e)throw new Error("OpenAI API key is not configured");const a="以下の運行ログのリストを読み取り、合計走行距離、合計運輸時間、合計休憩時間、給油回数と合計燃料消費、最长運行距離の日を日本語でまとめてください。ログはJSON配列です。",o=JSON.stringify(t),r={model:"gpt-3.5-turbo",messages:[{role:"system",content:a},{role:"user",content:o}],temperature:0};return(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(r)})).json()).choices[0].message.content}let s=null,C={},V;function O(t="現在位置を取得できませんでした。緯度と経度をカンマ区切りで入力してください（例: 43.06,141.35）"){const n=prompt(t,"");if(!n)throw new Error("緯度・経度の入力がキャンセルされました");const e=n.split(",");if(e.length!==2)return alert("緯度と経度をカンマ区切りで入力してください"),O(t);const a=parseFloat(e[0].trim()),o=parseFloat(e[1].trim());return isNaN(a)||isNaN(o)?(alert("緯度または経度が正しくありません"),O(t)):{lat:a,lng:o}}async function x(){return new Promise((t,n)=>{navigator.geolocation.getCurrentPosition(e=>{t({lat:e.coords.latitude,lng:e.coords.longitude})},()=>{try{const e=O();t(e)}catch(e){n(e)}},{enableHighAccuracy:!0})})}async function Y(){C=await F(),f(),window.addEventListener("online",()=>{D(),b()}),window.addEventListener("offline",D),b()}function D(){const t=document.getElementById("offline-banner");t&&(navigator.onLine?t.classList.add("hidden"):t.classList.remove("hidden"))}async function f(){const t=document.getElementById("app");t&&(t.innerHTML="",D(),s?t.appendChild(Z()):t.appendChild(await Q()))}async function Q(){const t=document.createElement("div");t.className="space-y-4";const n=document.createElement("div");n.className="bg-white p-4 rounded shadow";const e=document.createElement("button");e.className="w-full bg-blue-600 text-white py-3 rounded disabled:opacity-50",e.textContent="走行開始",e.onclick=()=>tt(),n.appendChild(e),t.appendChild(n);const a=document.createElement("div");a.className="bg-white p-4 rounded shadow";const o=document.createElement("h2");o.className="text-lg font-semibold mb-2",o.textContent="過去の走行ログ",a.appendChild(o);const r=await M();if(r.length===0){const l=document.createElement("p");l.textContent="まだログはありません。",a.appendChild(l)}else{const l=document.createElement("ul");l.className="divide-y",r.sort((m,p)=>m.date<p.date?1:-1);for(const m of r){const p=document.createElement("li");p.className="py-2 flex justify-between items-center";const h=document.createElement("span");h.innerHTML=` ${m.date} ：${m.departureName||"未設定"}→${m.arrivalName||"未設定"} / 距離 ${m.distanceKm.toFixed(1)}km`,p.appendChild(h);const i=document.createElement("button");i.className="ml-2 px-2 py-1 bg-red-500 text-white rounded text-xs",i.textContent="削除",i.onclick=async()=>{m.id!==void 0&&confirm("このログを削除しますか？")&&(await K(m.id),await f())},p.appendChild(i),l.appendChild(p)}a.appendChild(l);const u=document.createElement("button");u.className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded",u.textContent="スプレッドシートに同期",u.onclick=async()=>{await b(),C.SHEETS_WEBAPP_URL?alert("未送信のログを同期しました。"):alert("同期先のURLが設定されていません。config.jsonにSHEETS_WEBAPP_URLを指定してください。"),await f()},a.appendChild(u);const c=document.createElement("button");c.className="mt-2 px-4 py-2 bg-green-600 text-white rounded",c.textContent="CSVでエクスポート",c.onclick=async()=>{await it()},a.appendChild(c)}return t.appendChild(a),C.OPENAI_API_KEY&&t.appendChild(X()),t}function X(){const t=document.createElement("div");t.className="bg-white p-4 rounded shadow";const n=document.createElement("h2");n.className="text-lg font-semibold mb-2",n.textContent="AIアシスタント",t.appendChild(n);const e=document.createElement("div");e.className="space-y-2";const a=document.createElement("label");a.textContent="自然文から運行記録を作成",e.appendChild(a);const o=document.createElement("textarea");o.className="w-full p-2 border rounded h-24",o.placeholder="例：今日は6時に札幌を出発し、12時に帯広に到着しました。途中30分休憩し、250km走行しました。100L給油しました。",e.appendChild(o);const r=document.createElement("button");r.className="bg-green-600 text-white px-4 py-2 rounded",r.textContent="解析して保存",r.onclick=async()=>{if(o.value.trim()){r.disabled=!0,r.textContent="解析中...";try{const c=await z(o.value.trim()),m={date:c.departureTime?c.departureTime.split("T")[0]:new Date().toISOString().split("T")[0],departureName:c.departureName||"",arrivalName:c.arrivalName||"",departureTime:c.departureTime||"",arrivalTime:c.arrivalTime||"",drivingMinutes:c.drivingMinutes||0,breakMinutes:c.breakMinutes||0,distanceKm:c.distanceKm||0,fuelLitres:c.fuelLitres||0,fuelCost:c.fuelCost||0,departureLat:0,departureLng:0,arrivalLat:0,arrivalLng:0,note:c.note||""};await j(m,!navigator.onLine),await b(),o.value="",alert("解析したログを保存しました。"),f()}catch(c){alert("解析に失敗しました: "+c.message)}finally{r.disabled=!1,r.textContent="解析して保存"}}},e.appendChild(r),t.appendChild(e);const l=document.createElement("hr");l.className="my-4",t.appendChild(l);const u=document.createElement("button");return u.className="bg-purple-600 text-white px-4 py-2 rounded",u.textContent="ログの要約を作成",u.onclick=async()=>{u.disabled=!0,u.textContent="生成中...";try{const c=await M(),m=await G(c);alert(`要約:
`+m)}catch(c){alert("要約生成に失敗しました: "+c.message)}finally{u.disabled=!1,u.textContent="ログの要約を作成"}},t.appendChild(u),t}function Z(){const t=document.createElement("div");if(t.className="bg-white p-4 rounded shadow space-y-4",!s)return t;const n=Date.now(),e=A(s),a=B(s),o=n-s.startTime-e-a,r=document.createElement("h2");r.className="text-lg font-semibold",r.textContent="走行中",t.appendChild(r);const l=document.createElement("div");l.className="space-y-1 text-sm",l.innerHTML=`
 経過時間： ${I(o)} (運転), ${I(e)} (休憩), ${I(a)} (休息) 
 走行距離： ${s.distance.toFixed(2)} km 
 燃料記録：${s.fuelLogs.length}回 
  `,t.appendChild(l);const u=document.createElement("button"),c=s.breaks.length>0&&s.breaks[s.breaks.length-1].end===void 0;u.className="w-full py-3 rounded text-white "+(c?"bg-yellow-600":"bg-blue-600"),u.textContent=c?"休憩終了":"休憩開始",u.onclick=nt,t.appendChild(u);const m=document.createElement("button"),p=s.rests.length>0&&s.rests[s.rests.length-1].end===void 0;m.className="w-full py-3 rounded text-white "+(p?"bg-yellow-800":"bg-blue-700"),m.textContent=p?"休息終了":"休息開始",m.onclick=rt,t.appendChild(m);const h=document.createElement("button");h.className="w-full py-3 rounded bg-green-600 text-white",h.textContent="給油記録",h.onclick=ot,t.appendChild(h);const i=document.createElement("button");i.className="w-full py-3 rounded bg-red-600 text-white",i.textContent="走行終了",i.onclick=at,t.appendChild(i);const g=document.createElement("div");g.className="mt-4 max-h-40 overflow-y-auto border-t pt-2 text-xs space-y-1";const w=[];return s.breaks.forEach((d,L)=>{const S=new Date(d.start).toLocaleTimeString(),N=d.end?new Date(d.end).toLocaleTimeString():"",T=d.startLat!==void 0?`(${d.startLat.toFixed(5)},${(d.startLng??0).toFixed(5)})`:"",P=d.endLat!==void 0?`(${d.endLat.toFixed(5)},${(d.endLng??0).toFixed(5)})`:"";w.push(`休憩${L+1}: ${S}${T} - ${N}${P}`)}),s.rests.forEach((d,L)=>{const S=new Date(d.start).toLocaleTimeString(),N=d.end?new Date(d.end).toLocaleTimeString():"",T=d.startLat!==void 0?`(${d.startLat.toFixed(5)},${(d.startLng??0).toFixed(5)})`:"",P=d.endLat!==void 0?`(${d.endLat.toFixed(5)},${(d.endLng??0).toFixed(5)})`:"";w.push(`休息${L+1}: ${S}${T} - ${N}${P}`)}),s.fuelLogs.forEach((d,L)=>{const S=new Date(d.time).toLocaleTimeString();w.push(`給油${L+1}: ${S} (${d.lat.toFixed(5)},${d.lng.toFixed(5)}) ${d.amount}L ¥${d.cost??0}`)}),g.innerHTML=w.map(d=>` ${d} `).join(""),t.appendChild(g),t}async function tt(){if(!s)try{const{lat:t,lng:n}=await x(),e={lat:t,lng:n,timestamp:Date.now()};s={startTime:Date.now(),startCoord:e,coords:[e],distance:0,breaks:[],rests:[],fuelLogs:[],watchId:void 0};const a=J(et,()=>{});s.watchId=a,V=window.setInterval(()=>{s&&f()},1e3),f()}catch(t){alert("現在位置の取得に失敗しました: "+t.message)}}function et(t){if(!s)return;const n=s.coords,e=n[n.length-1],a=q(e,t);a*1e3>=50&&(s.distance+=a,s.coords.push(t),f())}async function nt(){if(!s)return;const t=s.breaks;if(t.length>0&&t[t.length-1].end===void 0)try{const{lat:n,lng:e}=await x();t[t.length-1].end=Date.now(),t[t.length-1].endLat=n,t[t.length-1].endLng=e}catch{t[t.length-1].end=Date.now()}else try{const{lat:n,lng:e}=await x();t.push({start:Date.now(),startLat:n,startLng:e})}catch{t.push({start:Date.now()})}f()}async function ot(){if(!s)return;const t=prompt("給油量 (リットル) を入力してください:","0");if(!t)return;const n=parseFloat(t);if(isNaN(n)||n<=0){alert("数値を入力してください。");return}const e=prompt("給油費用 (円) を入力してください（任意）:","0");let a=0;if(e){const o=parseFloat(e);!isNaN(o)&&o>0&&(a=o)}try{const{lat:o,lng:r}=await x();s.fuelLogs.push({time:Date.now(),amount:n,cost:a,lat:o,lng:r})}catch{s.fuelLogs.push({time:Date.now(),amount:n,cost:a,lat:0,lng:0})}f()}async function at(){if(!s)return;s.watchId!==void 0&&W(s.watchId);let t=0,n=0,e=Date.now();try{const{lat:i,lng:g}=await x();t=i,n=g,e=Date.now()}catch{}const a={lat:t,lng:n,timestamp:e};s.coords.push(a);const o=s.distance,r=A(s),l=B(s),u=Date.now()-s.startTime-r-l,c={date:new Date(s.startTime).toISOString().split("T")[0],departureName:"",arrivalName:"",departureTime:new Date(s.startTime).toISOString(),arrivalTime:new Date().toISOString(),drivingMinutes:Math.floor(u/6e4),breakMinutes:Math.floor(r/6e4),distanceKm:parseFloat(o.toFixed(3)),fuelLitres:s.fuelLogs.reduce((i,g)=>i+g.amount,0),fuelCost:s.fuelLogs.reduce((i,g)=>i+(g.cost||0),0),departureLat:s.startCoord?s.startCoord.lat:0,departureLng:s.startCoord?s.startCoord.lng:0,arrivalLat:a.lat,arrivalLng:a.lng,note:""};if(s.startCoord){const i=s.startCoord.lat,g=s.startCoord.lng;c.departureName=`https://www.google.com/maps?q=${i},${g}`}c.arrivalName=`https://www.google.com/maps?q=${a.lat},${a.lng}`;const m=prompt("備考（任意）：","");m!==null&&m.trim()!==""&&(c.note=m.trim());const p=Math.floor(l/6e4),h=[];p>0&&h.push(`休息合計:${p}分`),s.breaks.forEach((i,g)=>{const w=new Date(i.start).toISOString(),d=i.end?new Date(i.end).toISOString():"",L=i.startLat!==void 0?`(${i.startLat.toFixed(5)},${(i.startLng??0).toFixed(5)})`:"",S=i.endLat!==void 0?`(${i.endLat.toFixed(5)},${(i.endLng??0).toFixed(5)})`:"";h.push(`休憩${g+1}:${w}${L}-${d}${S}`)}),s.rests.forEach((i,g)=>{const w=new Date(i.start).toISOString(),d=i.end?new Date(i.end).toISOString():"",L=i.startLat!==void 0?`(${i.startLat.toFixed(5)},${(i.startLng??0).toFixed(5)})`:"",S=i.endLat!==void 0?`(${i.endLat.toFixed(5)},${(i.endLng??0).toFixed(5)})`:"";h.push(`休息${g+1}:${w}${L}-${d}${S}`)}),s.fuelLogs.forEach((i,g)=>{const w=new Date(i.time).toISOString();h.push(`給油${g+1}:${w}(${i.lat.toFixed(5)},${i.lng.toFixed(5)}) ${i.amount}L ¥${i.cost??0}`)}),c.note=[c.note,...h].filter(Boolean).join(" | "),await j(c,!navigator.onLine),await b(),s=null,f()}function A(t){return t.breaks.reduce((n,e)=>{const a=e.end||Date.now();return n+(a-e.start)},0)}function B(t){return t.rests.reduce((n,e)=>{const a=e.end||Date.now();return n+(a-e.start)},0)}function I(t){const n=Math.floor(t/1e3),e=Math.floor(n/3600),a=Math.floor(n%3600/60),o=n%60;return`${e}時間${a}分${o}秒`}async function rt(){if(!s)return;const t=s.rests;if(t.length>0&&t[t.length-1].end===void 0)try{const{lat:n,lng:e}=await x();t[t.length-1].end=Date.now(),t[t.length-1].endLat=n,t[t.length-1].endLng=e}catch{t[t.length-1].end=Date.now()}else try{const{lat:n,lng:e}=await x();t.push({start:Date.now(),startLat:n,startLng:e})}catch{t.push({start:Date.now()})}f()}async function b(){if(!navigator.onLine||!C.SHEETS_WEBAPP_URL)return;const t=await k();if(t.length!==0){for(const n of t)try{await st(n)}catch(e){console.warn("Failed to post log, will retry later",e);return}await H()}}async function st(t){if(!C.SHEETS_WEBAPP_URL)throw new Error("SHEETS_WEBAPP_URL is not configured");const n=await fetch(C.SHEETS_WEBAPP_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error("Failed to post log: HTTP "+n.status);const e=await n.json();if(!e||!e.ok)throw new Error("Server error: "+JSON.stringify(e))}async function it(){const t=await M();if(t.length===0){alert("エクスポートするログがありません。");return}const n=["date","departureName","arrivalName","departureTime","arrivalTime","drivingMinutes","breakMinutes","distanceKm","fuelLitres","fuelCost","departureLat","departureLng","arrivalLat","arrivalLng","note"],e=[];e.push(n.join(","));for(const u of t){const c=n.map(m=>{const p=u[m];return p==null?"":typeof p=="string"?`"${p.replace(/"/g,'""')}"`:p.toString()});e.push(c.join(","))}const a=e.join(`
`),o=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(o),l=document.createElement("a");l.href=r,l.download=`transport_logs_${new Date().toISOString().split("T")[0]}.csv`,l.click(),URL.revokeObjectURL(r)}Y().catch(t=>{console.error("Failed to initialise application:",t)});
